<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Women in Agriculture — Global South</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%;
      background: #EDF6E0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #2d3a1f;
      overflow: hidden;
    }
    .slide {
      width: 100vw; height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      padding: 16px 22px 10px;
      gap: 8px;
    }

    header {
      display: flex; align-items: center; justify-content: space-between;
    }
    .title-block h1 { font-size: 1.1rem; font-weight: 700; color: #1a2910; letter-spacing: -0.01em; line-height: 1.3; }
    .title-block p  { font-size: 0.85rem; color: #7a9455; margin-top: 2px; font-weight: 400; }
    .source-bar     { font-size: 0.7rem; color: #9ab87a; padding: 0 2px 2px; }

    .right-controls { display: flex; align-items: center; gap: 16px; }
    .legend { display: flex; align-items: center; gap: 10px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; color: #556b3a; font-weight: 600; }
    .legend-swatch { width: 16px; height: 16px; border-radius: 2px; }

    .toggle-group { display: flex; background: #d4e9b8; border-radius: 7px; padding: 3px; gap: 3px; }
    .toggle-btn {
      padding: 6px 18px; border: none; border-radius: 5px;
      font-size: 0.9rem; font-weight: 600; cursor: pointer;
      background: transparent; color: #7a9455; transition: all 0.15s;
    }
    .toggle-btn.active { background: #EDF6E0; color: #1a2910; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }

    /* chart fills body, map overlays top-right */
    .body { position: relative; min-height: 0; border-radius: 10px; overflow: hidden; background: #EDF6E0; }
    #chart-svg { display: block; width: 100%; height: 100%; }

    /* map overlay — wider rectangle */
    .map-panel {
      position: absolute; top: 10px; right: 10px;
      width: 310px; height: 160px;
      border-radius: 8px; background: #b8d898;
      overflow: hidden; display: flex; flex-direction: column;
      box-shadow: 0 2px 14px rgba(30,60,10,0.25);
      z-index: 10;
    }
    .map-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 4px 8px 1px; flex-shrink: 0;
    }
    .map-label { font-size: 0.7rem; font-weight: 700; color: #3a5820; text-transform: uppercase; letter-spacing: 0.06em; }
    .map-hint  { font-size: 0.65rem; color: #7a9455; }
    #map-canvas { flex: 1; display: block; width: 100%; cursor: pointer; }


    .tooltip {
      position: fixed; background: #1a2910ee; color: #edf6e0;
      padding: 9px 14px; border-radius: 8px; font-size: 0.85rem;
      pointer-events: none; opacity: 0; transition: opacity 0.1s;
      line-height: 1.7; white-space: nowrap; z-index: 999;
    }
    .tooltip strong { display: block; font-size: 0.95rem; margin-bottom: 2px; }
  </style>
</head>
<body>
<div class="slide">
  <header>
    <div class="title-block">
      <h1>Women make a significant proportion of agricultural labour, but lack ownership of land titles and resources</h1>
      <p id="subtitle">Share of women employed in agriculture (in %)</p>
    </div>
    <div class="right-controls">
      <div class="toggle-group">
        <button class="toggle-btn active" data-metric="Employment">Employment</button>
        <button class="toggle-btn" data-metric="Land Ownership">Land Ownership</button>
      </div>
    </div>
  </header>

  <div class="body">
    <svg id="chart-svg"></svg>
    <div class="map-panel">
      <div class="map-header">
        <div class="map-label">Global South — Women %</div>
        <div class="map-hint">click to highlight</div>
      </div>
      <canvas id="map-canvas"></canvas>
    </div>
  </div>
  <div class="source-bar">Source: ILO, FAO (UN) via Our World in Data</div>
</div>
<div class="tooltip" id="tooltip"></div>

<script>
/* ═══════════════ NAME MAPPING ═══════════════ */
/* GeoJSON NAME_LONG now matches CSV Entity names exactly (patched at source).
   No remapping needed — pass through directly. */
function shpToDataset(n) { return n; }

const GLOBAL_SOUTH = new Set([
  "Algeria","American Samoa","Argentina","Bangladesh","Belize","Botswana","Brazil",
  "Burkina Faso","Cape Verde","Chile","Comoros","Cote d'Ivoire",
  "Democratic Republic of Congo","Dominican Republic","Ecuador","Egypt",
  "El Salvador","Ethiopia","Fiji","Gambia","Georgia","Guam","Guatemala",
  "Guinea","Haiti","India","Indonesia","Iran","Jamaica","Jordan","Kyrgyzstan",
  "Laos","Lebanon","Lesotho","Madagascar","Malawi","Malaysia","Mali","Mexico",
  "Morocco","Mozambique","Myanmar","Nepal","Nicaragua","Nigeria",
  "Northern Mariana Islands","Panama","Peru","Philippines","Puerto Rico",
  "Saint Kitts and Nevis","Saint Lucia","Samoa","Saudi Arabia","Senegal",
  "Seychelles","Sri Lanka","Tanzania","Thailand","Trinidad and Tobago",
  "Tunisia","Uganda","Uruguay","Venezuela","Vietnam","Zambia"
]);

/* ═══════════════ DATA ═══════════════ */
/* Start with empty data - will be populated from CSVs */
const RAW = [];
const dataByName = {};

/* ═══════════════ CHOROPLETH ═══════════════ */
const choroScale = d3.scaleSequential()
  .domain([0, 100])
  .interpolator(d3.interpolate('#f9e4b0', '#5b21b6'));


/* ═══════════════ STATE ═══════════════ */
let currentMetric = 'Employment';
let selectedCountry = null;
let geoData = null;

/* ═══════════════ TOOLTIP ═══════════════ */
const tipEl = document.getElementById('tooltip');
function showTip(ev, country, wPct) {
  tipEl.innerHTML = `<strong>${country}</strong>
    <span style="color:#c4a0ff">&#9632; Women: ${wPct.toFixed(1)}%</span><br>
    <span style="color:#d4dd88">&#9632; Men: ${(100-wPct).toFixed(1)}%</span>`;
  tipEl.style.opacity = '1';

  /* Smart positioning: show on left if mouse on right half, else on right */
  const viewportWidth = window.innerWidth;
  if (ev.clientX > viewportWidth / 2) {
    /* Mouse on right side → show tooltip on left */
    tipEl.style.left = (ev.clientX - tipEl.offsetWidth - 14) + 'px';
  } else {
    /* Mouse on left side → show tooltip on right */
    tipEl.style.left = (ev.clientX + 14) + 'px';
  }
  tipEl.style.top  = (ev.clientY - 12) + 'px';
}
function hideTip() { tipEl.style.opacity = '0'; }

/* ═══════════════ BUILD DATA ═══════════════ */
function buildData(metric) {
  const key = metric === 'Employment' ? 'em' : 'ow';
  return RAW
    .filter(d => d[key] !== null && d[key] !== undefined)
    .map(d => ({ country: d.c, women: d[key], men: -(100 - d[key]) }))
    .sort((a, b) => b.women - a.women);
}

/* ═══════════════ CHART with full positional transitions ═══════════════ */
let chartInitialised = false;

function drawChart(metric, sel, animate) {
  const data  = buildData(metric);
  const svgEl = document.getElementById('chart-svg');
  const W = svgEl.clientWidth  || 900;
  const H = svgEl.clientHeight || 460;
  const margin = { top: 22, right: 14, bottom: 72, left: 30 };
  const iW = W - margin.left - margin.right;
  const iH = H - margin.top  - margin.bottom;

  const svg = d3.select('#chart-svg');
  const dur = animate ? 650 : 0;

  const x = d3.scaleBand().domain(data.map(d => d.country)).range([0, iW]).padding(0.12);
  const y = d3.scaleLinear().domain([-100, 100]).range([iH, 0]);
  const zero = y(0);
  const bw = x.bandwidth();

  /* ── first render: build static skeleton ── */
  if (!chartInitialised) {
    svg.selectAll('*').remove();
    chartInitialised = true;

    const g = svg.append('g').attr('class','chart-g')
      .attr('transform', `translate(${margin.left},${margin.top})`);

    [-100,-75,-50,-25,0,25,50,75,100].forEach(v => {
      g.append('line').attr('class','gridline')
        .attr('x1',0).attr('x2',iW).attr('y1',y(v)).attr('y2',y(v))
        .attr('stroke', v===0 ? '#4a6830' : '#c4dba0')
        .attr('stroke-width', v===0 ? 1.5 : 0.6)
        .attr('stroke-dasharray', v===0 ? null : '3,3');
    });

    g.append('g').attr('class','bars-layer');
    g.append('g').attr('class','xlabels-layer');
    g.append('g').attr('class','sellabels-layer');

    svg.append('text').attr('class','side-label-w')
      .attr('x',margin.left+4).attr('y',margin.top+20)
      .attr('font-size','20px').attr('font-weight','700').attr('fill','#7c3aed').text('▲ Women (%)');
    svg.append('text').attr('class','side-label-m')
      .attr('x',margin.left+4).attr('y',margin.top+iH-8)
      .attr('font-size','20px').attr('font-weight','700').attr('fill','#CAD487').text('▼ Men (%)');
  }

  const g           = svg.select('.chart-g');
  const barsLayer   = g.select('.bars-layer');
  const xlabsLayer  = g.select('.xlabels-layer');
  const sellabLayer = g.select('.sellabels-layer');
  const hasSel      = sel !== null;

  /* ── WOMEN BARS — transition x, y, height together ── */
  barsLayer.selectAll('.bar-w')
    .data(data, d => d.country)
    .join(
      enter => enter.append('rect').attr('class','bar-w')
        .attr('x', d => x(d.country)).attr('width', bw)
        .attr('y', zero).attr('height', 0).attr('rx', 1.5)
        .style('cursor','pointer')
        .on('mousemove', (ev,d) => showTip(ev, d.country, d.women))
        .on('mouseleave', hideTip)
        .on('click', (_,d) => handleSelect(d.country))
    )
    .on('mousemove', (ev,d) => showTip(ev, d.country, d.women))
    .on('mouseleave', hideTip)
    .on('click', (_,d) => handleSelect(d.country))
    .attr('fill', d => (!hasSel || sel===d.country) ? '#7c3aed' : '#c4b0e828')
    .attr('width', bw)
    .transition().duration(dur).ease(d3.easeCubicInOut)
      .attr('x', d => x(d.country))
      .attr('y', d => y(d.women))
      .attr('height', d => zero - y(d.women));

  /* ── MEN BARS ── */
  barsLayer.selectAll('.bar-m')
    .data(data, d => d.country)
    .join(
      enter => enter.append('rect').attr('class','bar-m')
        .attr('x', d => x(d.country)).attr('width', bw)
        .attr('y', zero).attr('height', 0).attr('rx', 1.5)
        .style('cursor','pointer')
        .on('mousemove', (ev,d) => showTip(ev, d.country, d.women))
        .on('mouseleave', hideTip)
        .on('click', (_,d) => handleSelect(d.country))
    )
    .on('mousemove', (ev,d) => showTip(ev, d.country, d.women))
    .on('mouseleave', hideTip)
    .on('click', (_,d) => handleSelect(d.country))
    .attr('fill', d => (!hasSel || sel===d.country) ? '#CAD487' : '#a8ddb028')
    .attr('width', bw)
    .transition().duration(dur).ease(d3.easeCubicInOut)
      .attr('x', d => x(d.country))
      .attr('y', zero)
      .attr('height', d => y(d.men) - zero);

  /* ── % LABELS on selected bar ── */
  sellabLayer.selectAll('*').remove();
  if (sel) {
    const sd = data.find(d => d.country === sel);
    if (sd) {
      const bx = x(sd.country) + bw / 2;
      sellabLayer.append('text').attr('class','sel-label')
        .attr('x', bx).attr('y', y(sd.women) - 4)
        .attr('text-anchor','middle')
        .attr('font-size','12px').attr('font-weight','700').attr('fill','#5b21b6')
        .text(sd.women.toFixed(1) + '%');
      sellabLayer.append('text').attr('class','sel-label')
        .attr('x', bx).attr('y', y(sd.men) + 13)
        .attr('text-anchor','middle')
        .attr('font-size','12px').attr('font-weight','700').attr('fill','#8a9933')
        .text((-sd.men).toFixed(1) + '%');
    }
  }

  /* ── X LABELS — all countries, transition x position ── */
  xlabsLayer.selectAll('.xlabel')
    .data(data, d => d.country)
    .join(
      enter => enter.append('text').attr('class','xlabel')
        .attr('text-anchor','end')
        .attr('y', iH + 5)
        .attr('x', d => x(d.country) + bw/2)
        .attr('transform', d => { const cx = x(d.country)+bw/2; return `rotate(-55,${cx},${iH+5})`; })
        .attr('opacity', 0)
    )
    .attr('font-size', d => sel===d.country ? '11px' : '9.5px')
    .attr('fill',       d => sel===d.country ? '#1a2910' : '#556b3a')
    .attr('font-weight',d => sel===d.country ? '700' : '500')
    .attr('y', iH + 5)
    .transition().duration(dur).ease(d3.easeCubicInOut)
      .attr('opacity', 1)
      .attr('x', d => x(d.country) + bw/2)
      .attr('transform', d => { const cx = x(d.country)+bw/2; return `rotate(-55,${cx},${iH+5})`; })
      .text(d => d.country);
}

/* ═══════════════ MAP (Canvas-based) ═══════════════ */
const mapCanvas = document.getElementById('map-canvas');
const mapCtx = mapCanvas.getContext('2d');
let MAP_W, MAP_H, baseScale, baseOffX, baseOffY;
let hoveredCountry = null;

function initMapCanvas() {
  const panel = mapCanvas.parentElement;
  const r = panel.getBoundingClientRect();
  MAP_W = 310;
  MAP_H = r.height - 22; /* subtract header height */
  mapCanvas.width = MAP_W * devicePixelRatio;
  mapCanvas.height = MAP_H * devicePixelRatio;
  mapCtx.scale(devicePixelRatio, devicePixelRatio);

  /* Global South bbox: lon -118 to 141 (259° wide), lat -56 to 44 (100° tall)
     Center: lon 11.5, lat -6 */
  const pad = 8;
  const lonMin = -118, lonMax = 141, latMin = -56, latMax = 44;
  const lonRange = lonMax - lonMin; /* 259° */
  const latRange = latMax - latMin; /* 100° */
  const regionAspect = lonRange / latRange; /* ~2.59 */
  const canvasAspect = MAP_W / MAP_H;

  if (canvasAspect > regionAspect) {
    /* Canvas wider → fit to height */
    baseScale = (MAP_H - 2*pad) / (latRange / 180);
    baseOffX = (MAP_W - baseScale * (lonRange / 180)) / 2;
    baseOffY = pad;
  } else {
    /* Canvas taller → fit to width */
    baseScale = (MAP_W - 2*pad) / (lonRange / 180);
    baseOffX = pad;
    baseOffY = (MAP_H - baseScale * (latRange / 180)) / 2;
  }

  /* Shift to center the region */
  const unitLonMin = (lonMin + 180) / 360;
  const unitLatMax = (90 - latMax) / 180;
  baseOffX -= unitLonMin * baseScale * 2;
  baseOffY -= unitLatMax * baseScale;
}

/* Equirectangular projection */
function lonLatToUnit(lon, lat) {
  return [(lon + 180) / 360, (90 - lat) / 180];
}
function unitToScreen(ux, uy) {
  /* ux,uy are in [0,1]. World aspect is 2:1, so x spans 2× baseScale */
  return [baseOffX + ux * baseScale * 2, baseOffY + uy * baseScale];
}

function drawMap(metric, sel) {
  if (!geoData) return;
  const key = metric === 'Employment' ? 'em' : 'ow';

  mapCtx.clearRect(0, 0, MAP_W, MAP_H);

  /* Ocean background */
  mapCtx.fillStyle = '#a8c98a';
  mapCtx.fillRect(0, 0, MAP_W, MAP_H);

  geoData.features.forEach(feat => {
    const geom = feat.geometry;
    if (!geom) return;

    const dname = shpToDataset(feat.properties.NAME_LONG);
    const isGS = GLOBAL_SOUTH.has(dname);
    const row = dataByName[dname];
    const val = row ? row[key] : null;

    const polys = geom.type === 'Polygon' ? [geom.coordinates] : geom.coordinates;

    mapCtx.beginPath();
    polys.forEach(poly => {
      poly.forEach(ring => {
        ring.forEach(([lon, lat], j) => {
          const [sx, sy] = unitToScreen(...lonLatToUnit(lon, lat));
          j === 0 ? mapCtx.moveTo(sx, sy) : mapCtx.lineTo(sx, sy);
        });
        mapCtx.closePath();
      });
    });

    /* Fill */
    if (dname === sel) {
      mapCtx.fillStyle = '#facc15'; /* selected: yellow */
    } else if (dname === hoveredCountry) {
      mapCtx.fillStyle = '#fdee88'; /* hover: light yellow */
    } else if (!isGS) {
      mapCtx.fillStyle = '#d0e8b0'; /* non-GS: pale green */
    } else if (val === null) {
      mapCtx.fillStyle = '#bdd89a'; /* GS no data: medium green */
    } else {
      mapCtx.fillStyle = choroScale(val);
    }
    mapCtx.fill();

    /* Borders */
    mapCtx.strokeStyle = dname === sel ? '#1a2910' : '#7aaa55';
    mapCtx.lineWidth = dname === sel ? 1.2 : 0.4;
    mapCtx.stroke();
  });
}

/* Hit test */
function hitTestMap(mx, my) {
  const sx = mx, sy = my;
  const ux = (sx - baseOffX) / (baseScale * 2);
  const uy = (sy - baseOffY) / baseScale;
  const lon = ux * 360 - 180;
  const lat = 90 - uy * 180;

  for (let i = geoData.features.length - 1; i >= 0; i--) {
    const feat = geoData.features[i];
    const geom = feat.geometry;
    if (!geom) continue;
    const polys = geom.type === 'Polygon' ? [geom.coordinates] : geom.coordinates;
    for (const poly of polys) {
      for (const ring of poly) {
        if (pointInRing(lon, lat, ring)) {
          return shpToDataset(feat.properties.NAME_LONG);
        }
      }
    }
  }
  return null;
}

function pointInRing(px, py, ring) {
  let inside = false;
  for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
    const xi = ring[i][0], yi = ring[i][1];
    const xj = ring[j][0], yj = ring[j][1];
    if (((yi > py) !== (yj > py)) && px < (xj - xi) * (py - yi) / (yj - yi) + xi)
      inside = !inside;
  }
  return inside;
}

/* Events */
mapCanvas.addEventListener('mousemove', ev => {
  const r = mapCanvas.getBoundingClientRect();
  const mx = ev.clientX - r.left;
  const my = ev.clientY - r.top;
  const country = hitTestMap(mx, my);

  if (country !== hoveredCountry) {
    hoveredCountry = country;
    drawMap(currentMetric, selectedCountry);
  }

  if (country && GLOBAL_SOUTH.has(country)) {
    const key = currentMetric === 'Employment' ? 'em' : 'ow';
    const row = dataByName[country];
    if (row && row[key] !== null) {
      showTip(ev, country, row[key]);
    } else {
      hideTip();
    }
  } else {
    hideTip();
  }
});

mapCanvas.addEventListener('mouseleave', () => {
  hoveredCountry = null;
  hideTip();
  drawMap(currentMetric, selectedCountry);
});

mapCanvas.addEventListener('click', ev => {
  const r = mapCanvas.getBoundingClientRect();
  const mx = ev.clientX - r.left;
  const my = ev.clientY - r.top;
  const country = hitTestMap(mx, my);

  if (country && GLOBAL_SOUTH.has(country)) {
    const key = currentMetric === 'Employment' ? 'em' : 'ow';
    const row = dataByName[country];
    if (row && row[key] !== null) {
      handleSelect(country);
    }
  }
});

/* ═══════════════ INTERACTION ═══════════════ */
function handleSelect(country) {
  selectedCountry = selectedCountry === country ? null : country;
  drawChart(currentMetric, selectedCountry, false);
  drawMap(currentMetric, selectedCountry);
}

/* ═══════════════ TOGGLE ═══════════════ */
const SUBTITLES = {
  Employment: 'Share of women employed in agriculture (in %)',
  'Land Ownership':  'Share of women with secure tenure rights over agricultural land (in %)',
};

document.querySelectorAll('.toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentMetric = btn.dataset.metric;
    document.getElementById('subtitle').textContent = SUBTITLES[currentMetric];
    /* keep selection if the country has data in the new metric, else clear */
    if (selectedCountry) {
      const key = currentMetric === 'Employment' ? 'em' : 'ow';
      const row = dataByName[selectedCountry];
      if (!row || row[key] === null || row[key] === undefined) selectedCountry = null;
    }
    drawChart(currentMetric, selectedCountry, true);   /* animate = true */
    drawMap(currentMetric, selectedCountry);
  });
});

/* ═══════════════ INIT ═══════════════ */
/* Show loading indicator */
const loadingDiv = document.createElement('div');
loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; color: #556b3a; font-weight: 600;';
loadingDiv.textContent = 'Loading data...';
document.body.appendChild(loadingDiv);

/* Load data files with individual error tracking */
const filePromises = [
  { name: 'world_simple.geojson', promise: d3.json('world_simple.geojson') },
  { name: 'employment.csv', promise: d3.csv('employment.csv') },
  { name: 'womeninagri.csv', promise: d3.csv('womeninagri.csv') },
  { name: 'landown.csv', promise: d3.csv('landown.csv') }
];

Promise.all(filePromises.map(f =>
  f.promise.catch(err => {
    console.error(`Failed to load ${f.name}:`, err);
    throw new Error(`Failed to load ${f.name}: ${err.message}`);
  })
))
  .then(([geoJson, employmentData, womenInAgriData, landownData]) => {
    /* Remove loading indicator */
    loadingDiv.remove();

    geoData = geoJson;

    /* Build RAW array from employment data */
    employmentData.forEach(row => {
      const country = row.Entity;
      if (!GLOBAL_SOUTH.has(country)) return; /* Only Global South */

      const femaleEmp = parseFloat(row['Female employment in agriculture']);
      if (isNaN(femaleEmp)) return;

      RAW.push({ c: country, em: femaleEmp, ow: null });
    });

    /* Merge ownership data from womeninagri.csv (only Female rows) */
    womenInAgriData.forEach(row => {
      const country = row.Entity;
      if (row.Gender !== 'Female') return; /* Only Female rows */
      if (!GLOBAL_SOUTH.has(country)) return; /* Only Global South */

      const femaleOwn = parseFloat(row.Ownership);
      if (isNaN(femaleOwn)) return;

      const existing = RAW.find(r => r.c === country);
      if (existing) {
        existing.ow = femaleOwn;
      } else {
        RAW.push({ c: country, em: null, ow: femaleOwn });
      }
    });

    /* Override with land ownership data from landown.csv (takes precedence) */
    landownData.forEach(row => {
      const country = row.Entity;
      if (!GLOBAL_SOUTH.has(country)) return; /* Only Global South */

      const femaleOwn = parseFloat(row['Female-landown']);
      if (isNaN(femaleOwn)) return;

      const existing = RAW.find(r => r.c === country);
      if (existing) {
        existing.ow = femaleOwn; /* Override existing value */
      } else {
        RAW.push({ c: country, em: null, ow: femaleOwn });
      }
    });

    /* Build dataByName lookup */
    RAW.forEach(d => dataByName[d.c] = d);

    initMapCanvas();
    drawChart(currentMetric, null, false);
    drawMap(currentMetric, null);
  })
  .catch(err => {
    console.error('Data load error:', err);
    /* Show error message to user */
    document.body.innerHTML = `
      <div style="padding: 40px; font-family: system-ui; max-width: 800px; margin: 0 auto;">
        <h1 style="color: #c00;">Data Loading Error</h1>
        <p style="margin: 20px 0;">Failed to load required data files. Please check:</p>
        <ul style="line-height: 2;">
          <li>All CSV and GeoJSON files are in the same directory as index.html</li>
          <li>Files: employment.csv, womeninagri.csv, landown.csv, world_simple.geojson</li>
          <li>GitHub Pages is enabled (Settings → Pages → Deploy from main branch)</li>
        </ul>
        <p style="margin: 20px 0; padding: 10px; background: #f5f5f5; font-family: monospace;">
          Error: ${err.message || err}
        </p>
      </div>
    `;
  });

window.addEventListener('resize', () => {
  chartInitialised = false;
  initMapCanvas();
  drawChart(currentMetric, selectedCountry, false);
  drawMap(currentMetric, selectedCountry);
});
</script>
</body>
</html>
